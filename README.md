# SSO (Single Sign-On) Service

Микросервис для аутентификации и авторизации пользователей с использованием gRPC API.

## Описание

SSO сервис предоставляет централизованную систему аутентификации, позволяющую пользователям регистрироваться и входить в различные приложения через единую точку входа. Сервис использует JWT токены для аутентификации и поддерживает работу с несколькими приложениями. Система включает контроль доступа на уровне связей пользователь-приложение, что позволяет гибко управлять правами доступа к различным приложениям.

## Документация

- **[Интеграция с SSO](docs/INTEGRATION.md)** — архитектура (web/mobile/desktop → backend → SSO), API-контракты и сценарии взаимодействия.

## Основные возможности

- ✅ Регистрация новых пользователей
- ✅ Аутентификация пользователей (логин)
- ✅ Генерация JWT токенов для авторизации
- ✅ Валидация JWT токенов
- ✅ Ограничение частоты запросов на логин (rate limit по email, через Redis)
- ✅ Управление доступом пользователей к приложениям (grant/revoke access)
- ✅ Поддержка множественных приложений
- ✅ Контроль доступа на уровне user-app связей
- ✅ Хеширование паролей с использованием bcrypt
- ✅ Валидация входных данных
- ✅ Graceful shutdown
- ✅ Структурированное логирование

## Технологический стек

- **Go 1.24+**
- **gRPC** — для API коммуникации
- **SQLite** — для хранения данных
- **Redis** — для счётчиков rate limit (логин по email); при отключённом Redis лимит не применяется
- **JWT** — для токенов аутентификации
- **bcrypt** — для хеширования паролей
- **golang-migrate** — для миграций базы данных

## Структура проекта

```
sso/
├── cmd/
│   ├── migrator/         # Миграции БД
│   └── sso/              # Точка входа приложения
├── config/               # Конфигурационные файлы
├── internal/
│   ├── app/              # Инициализация приложения (grpc, redis, storage)
│   │   ├── grpc/         # gRPC-сервер, интерцепторы (logging, recovery, rate limit)
│   │   ├── redis/        # Подключение к Redis (опционально)
│   │   └── storage/      # Обёртка над хранилищем
│   ├── config/           # Загрузка конфигурации
│   ├── domain/models/    # Модели данных
│   ├── grpc/auth/        # gRPC-обработчики аутентификации
│   ├── lib/
│   │   ├── jwt/          # JWT-токены
│   │   └── logger/       # Логгер (pretty-вывод, sl)
│   ├── services/auth/    # Бизнес-логика аутентификации
│   └── storage/sqlite/   # Хранилище SQLite
├── migrations/           # Миграции схемы БД
├── tests/                # Интеграционные тесты
│   ├── migrations/       # Сиды приложений для тестов
│   └── suite/            # Test suite (клиент, порт/таймаут из env)
└── storage/              # Директория для файлов БД (SQLite)
```

## Установка и запуск

### Требования

- Go 1.24 или выше
- SQLite3
- Redis (опционально; для rate limit на логин; без Redis лимит не применяется)

### Установка зависимостей

```bash
go mod download
```

### Конфигурация

Файлы конфигурации в каталоге `config/`:

- **config_local.yaml** — для локального запуска сервера (БД `./storage/sso.db`)
- **config_local_tests.yaml** — для запуска сервера при интеграционных тестах (БД `./storage/sso_test.db`, таймаут 60s)

Пример `config/config_local.yaml`:

```yaml
env: "local"
storage_path: "./storage/sso.db"
grpc:
  port: 8080
  timeout: 10s
redis:
  addr: "localhost:6379"
  password: ""
  rate_limits:
    login_limit: 5      # макс. попыток логина на один email за окно
    login_window: 1m    # окно для счётчика (1m, 5m и т.д.)
token_ttl: 1h
```

- **redis.addr** — адрес Redis; если пустой, Redis не подключается и rate limit отключён.
- **redis.rate_limits** — лимит попыток логина по email (при превышении — `ResourceExhausted`).

Путь к конфигу можно задать флагом `-config-path` или переменной окружения `CONFIG_PATH`.

### Запуск миграций

Перед первым запуском примените миграции:

```bash
go run ./cmd/migrator --storage-path=./storage/sso.db --migrations-path=./migrations
```

### Запуск приложения

```bash
go run ./cmd/sso/main.go -config-path ./config/config_local.yaml
```

Или через переменную окружения:
```bash
export CONFIG_PATH=./config/config_local.yaml
go run ./cmd/sso/main.go
```

## API

Описание API, контрактов и сценариев интеграции см. в [docs/INTEGRATION.md](docs/INTEGRATION.md).

## Безопасность

- Пароли хешируются с использованием bcrypt
- JWT токены подписываются секретом приложения
- Пароли не хранятся в открытом виде
- Валидация всех входных данных
- Ограничение частоты попыток логина по email (rate limit через Redis)
- Контроль доступа на уровне приложений (user-app связи)
- Проверка прав доступа при логине и валидации токена
- Каждое приложение имеет уникальный секрет для подписи токенов

## Тестирование

Интеграционные тесты подключаются к уже запущенному серверу. Тестовый клиент не читает конфиг сервера — порт и таймауты задаются переменными окружения с дефолтами (порт 8080, таймаут 60s, token TTL 1h). Для теста rate limit на логин нужен запущенный Redis (в тестовом конфиге уже указаны `redis.addr` и `rate_limits`).

**Порядок запуска**

1. (Опционально) Запустить Redis, если нужны тесты rate limit: `redis-server` или Docker.

2. Применить миграции к тестовой БД (один раз или после сброса):
   ```bash
   go run ./cmd/migrator --storage-path=./storage/sso_test.db --migrations-path=./migrations
   go run ./cmd/migrator --storage-path=./storage/sso_test.db --migrations-path=./tests/migrations --migrations-table=migrations_seed
   ```

3. Запустить сервер с тестовым конфигом:
   ```bash
   go run ./cmd/sso/main.go -config-path ./config/config_local_tests.yaml
   ```

4. В другом терминале запустить тесты:
   ```bash
   go test ./tests/...
   ```

**Переменные окружения для тестов** (по желанию):

| Переменная        | По умолчанию | Описание              |
|-------------------|--------------|------------------------|
| `SSO_GRPC_PORT`   | 8080         | Порт gRPC-сервера      |
| `SSO_GRPC_TIMEOUT`| 60s          | Таймаут запросов       |
| `SSO_TOKEN_TTL`   | 1h           | TTL токена (для проверки exp в тестах) |

## Логирование

Приложение поддерживает три режима логирования:

- **local** - цветной вывод для разработки
- **dev** - JSON формат с уровнем Debug
- **prod** - JSON формат с уровнем Info

Уровень логирования настраивается через поле `env` в конфигурации.

## Graceful Shutdown

Приложение поддерживает корректное завершение работы:
- Обработка сигналов SIGTERM и SIGINT
- Таймаут завершения: 10 секунд
- Корректное закрытие соединений с базой данных и Redis

## TODO

Список задач для дальнейшей разработки находится в файле [TODO.md](./TODO.md).